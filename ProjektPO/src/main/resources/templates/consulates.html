<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consulate Management</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
    <script defer src="/scripts/consulate-management.js"></script>
</head>
<body class="bg-gray-100 p-10">
<div class="container mx-auto bg-white shadow-lg rounded-xl">
    <header class="flex justify-between items-center bg-blue-700 text-white p-4 rounded-t-xl">
        <img src="/images/polish-coat-of-arms.png" alt="Logo" class="h-12 w-auto" />
        <span class="italic text-sm">
          <p>Ministerstwo</p>
          <p>Spraw</p>
          <p>Zagranicznych</p>
        </span>
    </header>

    <div class="container mx-auto bg-white shadow-lg rounded-b-xl p-6">
        <h1 class="text-2xl font-bold text-center text-blue-500">Consulate Management System</h1>

        <section class="mt-6 bg-gray-100 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-blue-500">Add Consulate</h2>
            <form id="add-consulate-form" class="mt-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Code</label>
                        <input type="text" id="consulate-code" placeholder="Enter consulate code"
                               class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500" />
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Country</label>
                        <select id="consulate-country" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Select a country</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mt-4 gap-4">
                    <button type="reset" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">Reset</button>
                    <button type="submit" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Save</button>
                </div>
            </form>
        </section>

        <!-- Consulate List Section -->
        <section class="mt-6 bg-gray-100 p-4 rounded-lg">
            <h2 class="text-lg font-semibold text-blue-500">Consulate List</h2>
            <form id="filter-form" class="mt-4">
                <div class="grid grid-cols-1 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Country</label>
                        <select id="filter-country" class="w-full mt-1 border-gray-300 rounded-lg shadow-sm focus:ring-blue-500 focus:border-blue-500">
                            <option value="" disabled selected>Select a country</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end mt-4 gap-4">
                    <button type="submit" class="px-4 py-2 bg-blue-700 text-white rounded-lg hover:bg-blue-800">Filter</button>
                </div>
            </form>

            <table id="consulate-table" class="table-auto w-full mt-4 border-collapse border border-gray-300">
                <thead>
                <tr class="bg-blue-700 text-white">
                    <th class="border border-gray-300 px-4 py-2">#</th>
                    <th class="border border-gray-300 px-4 py-2">Code</th>
                    <th class="border border-gray-300 px-4 py-2">Country</th>
                    <th class="border border-gray-300 px-4 py-2">Actions</th>
                </tr>
                </thead>
                <tbody>
                </tbody>
            </table>
        </section>
    </div>
</div>
</body>
<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const countrySelect = document.getElementById("consulate-country");
        const filterSelect = document.getElementById("filter-country");
        const form = document.getElementById("add-consulate-form");
        const filterForm = document.getElementById("filter-form");
        const consulateTable = document.querySelector("#consulate-table tbody");
        const successMessage = document.createElement("div");

        successMessage.className =
            "hidden text-green-700 bg-green-100 border border-green-400 px-4 py-3 rounded relative";
        successMessage.setAttribute("role", "alert");
        form.parentNode.insertBefore(successMessage, form);

        await populateCountriesDropdown(countrySelect)
        await populateCountriesDropdown(filterSelect)

        form.addEventListener("submit", async (event) => {
            event.preventDefault();
            const payload = {
                code: document.getElementById("consulate-code").value,
                countryName: countrySelect.value,
            };

            try {
                await createConsulate(payload);

                successMessage.textContent = "Consulate added successfully";
                successMessage.classList.remove("hidden");

                await fetchConsulatesAndUpdateTable();

                form.reset();

                setTimeout(() => {
                    successMessage.classList.add("hidden");
                }, 3000);
            } catch (error) {
                console.error(error);
                alert("Failed to add consulate. Please try again.");
            }
        });

        filterForm.addEventListener("submit", async (event) => {
                event.preventDefault();
                const selectedCountry = filterSelect.value;
                console.log(selectedCountry)

                if (!selectedCountry) {
                    return;
                }

                await fetchConsulatesByCountryAndUpdateTable(selectedCountry);
            }
        )


        async function populateCountriesDropdown(select) {
            try {
                const countries = await fetchCountries();
                countries.forEach((country) => {
                    const option = document.createElement("option");
                    option.value = country.code;
                    option.textContent = country.name;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error(error);
                alert("Failed to load countries. Please try again later.");
            }
        }

        async function fetchConsulatesByCountryAndUpdateTable(countryName) {
            console.log("RELOADING PAGE")
            try {
                console.log(countryName)
                const consulates = await fetchConsulatesByCountry(countryName);

                consulateTable.innerHTML = "";
                populateTable(consulates)
            } catch (error) {
                console.error(error);
                alert("Failed to fetch consulates. Please try again.");
            }
        }

        async function fetchConsulatesAndUpdateTable() {
            console.log("RELOADING PAGE")
            try {
                const consulates = await fetchConsulates();

                consulateTable.innerHTML = "";
                populateTable(consulates)
            } catch (error) {
                console.error(error);
                alert("Failed to fetch consulates. Please try again.");
            }
        }

        function populateTable(consulates) {
            consulates.forEach((consulate, index) => {
                const row = document.createElement("tr");
                row.innerHTML = `
                        <td class="border px-4 py-2">${index + 1}</td>
                        <td class="border px-4 py-2">${consulate.code}</td>
                        <td class="border px-4 py-2">${consulate.countryName}</td>
                        <td class="border px-4 py-2 flex gap-2">
                            <button
                                class="bg-green-500 text-white px-2 py-1 rounded hover:bg-green-600"
                                onclick="editConsulate(${consulate.id})">
                                Edit
                            </button>
                            <button
                                class="bg-red-500 text-white px-2 py-1 rounded hover:bg-red-600"
                                onclick="handleDeleteConsulate(${consulate.id})">
                                Delete
                            </button>
                        </td>
                    `;
                consulateTable.appendChild(row);
            });
        }

        window.handleDeleteConsulate = async function (id) {
            const confirmDelete = confirm("Are you sure you want to delete this consulate?");
            if (!confirmDelete) return;

            try {
                await deleteConsulateById(id);
                alert("Consulate deleted successfully!");

                await fetchConsulatesAndUpdateTable();
            } catch (error) {
                console.error("Error deleting consulate:", error);
                alert("Failed to delete consulate. Please try again.");
            }
        };

        window.editConsulate = function (id) {
            window.location.href = `/consulates/edit/${id}`;
        };

        await fetchConsulatesAndUpdateTable()
    });
</script>

</html>
