<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Consulate Management - Edit Consulate</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <script src="/scripts/consulate-management.js" defer></script>
</head>

<body class="bg-gray-100 p-10">
<div class="container mx-auto bg-white shadow-lg rounded-xl">
    <!-- Header -->
    <header class="flex justify-between items-center bg-blue-700 text-white p-4 rounded-t-xl">
        <img src="/images/polish-coat-of-arms.png" alt="Logo" class="h-12 w-auto" />
        <span class="italic text-sm">
            <p>Ministerstwo</p>
            <p>Spraw</p>
            <p>Zagranicznych</p>
        </span>
    </header>

    <div class="container mx-auto bg-white shadow-lg rounded-b-xl p-6">
        <div class="flex justify-center items-center">
            <div class="card w-96 bg-gray-100 shadow-xl p-6">
                <div class="card-body">
                    <h1 class="card-title text-center font-bold text-2xl text-blue-500">Edit Consulate</h1>
                    <form id="edit-consulate-form" class="space-y-4">
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Code</span>
                            </label>
                            <input required type="text" id="code" class="input input-bordered w-full" placeholder="Enter consulate code" />
                        </div>
                        <div class="form-control">
                            <label class="label">
                                <span class="label-text">Country</span>
                            </label>
                            <select required id="country" class="select select-bordered w-full">
                                <option value="" disabled selected>Select a country</option>
                                <!-- Countries will be populated here -->
                            </select>
                        </div>

                        <div class="divider divider-horizontal"></div>

                        <div class="flex justify-between items-center">
                            <button type="reset" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">Reset</button>
                            <button type="submit" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Save</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div class="flex justify-center items-end mt-4">
            <a href="/consulates" class="bg-red-500 text-white px-20 py-2 rounded-lg hover:bg-red-600">Cancel</a>
        </div>
        <footer class="mt-6 text-center text-gray-500 text-sm">
            &copy; 2024 Ministerstwo Spraw Zagranicznych
        </footer>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", async () => {
        const consulateId = window.location.pathname.split("/").pop();
        console.log(consulateId)
        const codeInput = document.getElementById("code");
        const countrySelect = document.getElementById("country");
        const form = document.getElementById("edit-consulate-form");

        if (!consulateId) {
            alert("No consulate ID provided. Redirecting to the consulate list.");
            window.location.href = "/consulates";
            return;
        }

        try {
            const countries = await fetchCountries();
            countries.forEach((country) => {
                const option = document.createElement("option");
                option.value = country.code;
                option.textContent = country.name;
                countrySelect.appendChild(option);
            });

            const consulate = await fetchConsulateById(consulateId);
            codeInput.value = consulate.code;
            countrySelect.value = consulate.countryName;
        } catch (error) {
            console.error(error);
            alert("Failed to load data. Redirecting to the consulate list.");
            window.location.href = "/consulates";
        }

        form.addEventListener("submit", async (event) => {
            event.preventDefault();

            if (!countrySelect.value && !codeInput.value && codeInput.value < 2) {
                alert("Failed to add consulate. Incorrect data.");
                return;
            }

            const payload = {
                id: Number(consulateId),
                code: codeInput.value,
                countryName: countrySelect.value,
            };

            try {
                await submitConsulateData(consulateId, payload)

                alert("Consulate updated successfully");
                window.location.href = "/consulates";
            } catch (error) {
                console.error(error);
                alert("Failed to update consulate. Please try again.");
            }
        });
    });
</script>

</body>
</html>
